{{- if .Values.waf.enabled }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "trustlayer.fullname" . }}-modsecurity-config
  labels:
    {{- include "trustlayer.labels" . | nindent 4 }}
data:
  modsecurity.conf: |
    # ModSecurity Configuration for TrustLayer
    # Based on OWASP ModSecurity Core Rule Set (CRS)

    # Enable ModSecurity
    SecRuleEngine {{ .Values.waf.ruleEngine | default "DetectionOnly" }}

    # Request body handling
    SecRequestBodyAccess On
    SecRequestBodyLimit {{ .Values.waf.requestBodyLimit | default 13107200 }}  # 12.5 MB
    SecRequestBodyNoFilesLimit {{ .Values.waf.requestBodyNoFilesLimit | default 131072 }}  # 128 KB
    SecRequestBodyLimitAction Reject
    SecRequestBodyInMemoryLimit {{ .Values.waf.requestBodyInMemoryLimit | default 131072 }}  # 128 KB

    # Response body handling
    SecResponseBodyAccess {{ .Values.waf.responseBodyAccess | default "Off" }}
    SecResponseBodyMimeType text/plain text/html text/xml application/json
    SecResponseBodyLimit {{ .Values.waf.responseBodyLimit | default 524288 }}  # 512 KB
    SecResponseBodyLimitAction ProcessPartial

    # Temporary directory
    SecTmpDir /tmp/
    SecDataDir /tmp/

    # Upload directory
    SecUploadDir /tmp/
    SecUploadKeepFiles Off

    # Debug log
    SecDebugLog /var/log/modsec_debug.log
    SecDebugLogLevel {{ .Values.waf.debugLogLevel | default 0 }}

    # Audit log
    SecAuditEngine {{ .Values.waf.auditEngine | default "RelevantOnly" }}
    SecAuditLogRelevantStatus "^(?:5|4(?!04))"
    SecAuditLogParts ABIJDEFHZ
    SecAuditLogType Serial
    SecAuditLog /var/log/modsec_audit.log

    # Argument separator
    SecArgumentSeparator &

    # Cookie format
    SecCookieFormat 0

    # Unicode mapping
    SecUnicodeMapFile unicode.mapping 20127

    # Status code for blocked requests
    SecDefaultAction "phase:1,log,auditlog,deny,status:{{ .Values.waf.blockStatusCode | default 403 }}"

{{- if .Values.waf.customRules }}
{{ .Values.waf.customRules | nindent 4 }}
{{- end }}

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "trustlayer.fullname" . }}-modsecurity-rules
  labels:
    {{- include "trustlayer.labels" . | nindent 4 }}
data:
  # OWASP CRS v3.3.x compatible rules
  trustlayer-rules.conf: |
    # TrustLayer Specific WAF Rules
    # These rules protect against common attacks while allowing legitimate traffic

    # ============================================
    # SQL Injection Protection
    # ============================================
    SecRule ARGS|ARGS_NAMES|REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_BODY|REQUEST_HEADERS|XML:/* "@detectSQLi" \
      "id:1001,\
      phase:2,\
      block,\
      t:none,t:urlDecodeUni,\
      msg:'SQL Injection Attack Detected',\
      logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
      tag:'application-multi',\
      tag:'language-multi',\
      tag:'platform-multi',\
      tag:'attack-sqli',\
      tag:'OWASP_CRS/WEB_ATTACK/SQL_INJECTION',\
      severity:'CRITICAL'"

    # ============================================
    # XSS Protection
    # ============================================
    SecRule ARGS|ARGS_NAMES|REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_BODY|REQUEST_HEADERS|XML:/*|!REQUEST_COOKIES:/__utm/|!REQUEST_COOKIES:/_pk_ref/ "@detectXSS" \
      "id:1002,\
      phase:2,\
      block,\
      t:none,t:utf8toUnicode,t:urlDecodeUni,t:htmlEntityDecode,t:jsDecode,t:cssDecode,t:removeNulls,\
      msg:'XSS Attack Detected',\
      logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
      tag:'application-multi',\
      tag:'language-multi',\
      tag:'platform-multi',\
      tag:'attack-xss',\
      tag:'OWASP_CRS/WEB_ATTACK/XSS',\
      severity:'CRITICAL'"

    # ============================================
    # Path Traversal Protection
    # ============================================
    SecRule REQUEST_URI|ARGS|ARGS_NAMES "@pmFromFile /etc/nginx/modsecurity/lfi-os-files.data" \
      "id:1003,\
      phase:2,\
      block,\
      t:none,t:utf8toUnicode,t:urlDecodeUni,t:normalizePathWin,t:lowercase,\
      msg:'Path Traversal Attack Detected',\
      logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
      tag:'application-multi',\
      tag:'language-multi',\
      tag:'platform-multi',\
      tag:'attack-lfi',\
      tag:'OWASP_CRS/WEB_ATTACK/FILE_INJECTION',\
      severity:'CRITICAL'"

    # ============================================
    # Command Injection Protection
    # ============================================
    SecRule ARGS|ARGS_NAMES "@rx (?i:(?:\b(?:(?:n(?:et(?:\b\W+?\blocalgroup|\.exe)|(?:map|c)\.exe)|t(?:(?:elne|f)t|clsh8?|ype)|(?:w(?:guest|sh)|rcmd|ftp)\.exe|echo\b\W*?\by+)\b|c(?:md(?:(?:32)?\.exe\b|\b\W*?\/c)|d(?:\b\W*?[\\\/]|\W*?\.\.)|hmod.{0,40}?\+.{0,3}x))|[\;\|\`]\W*?\b(?:(?:c(?:h(?:grp|mod|own|sh)|md|pp)|p(?:asswd|ython|erl|ing|s)|n(?:asm|map|c)|f(?:inger|tp)|(?:kil|mai)l|(?:xte)?rm|ls(?:of)?|telnet|uname|echo|id)\b)))" \
      "id:1004,\
      phase:2,\
      block,\
      t:none,t:urlDecodeUni,\
      msg:'System Command Injection Detected',\
      logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
      tag:'application-multi',\
      tag:'language-shell',\
      tag:'platform-unix',\
      tag:'attack-rce',\
      tag:'OWASP_CRS/WEB_ATTACK/COMMAND_INJECTION',\
      severity:'CRITICAL'"

    # ============================================
    # CSRF Protection (require CSRF token)
    # ============================================
    SecRule REQUEST_METHOD "@rx ^(?:POST|PUT|DELETE|PATCH)$" \
      "id:1005,\
      phase:2,\
      chain,\
      t:none,\
      msg:'Missing CSRF Token',\
      tag:'OWASP_CRS/WEB_ATTACK/CSRF',\
      severity:'WARNING'"
      SecRule &REQUEST_HEADERS:X-CSRF-Token "@eq 0" \
        "chain,\
        t:none"
        SecRule &REQUEST_COOKIES:csrf_token "@eq 0" \
          "t:none"

    # ============================================
    # Rate Limiting (IP-based)
    # ============================================
    # Track request count per IP
    SecAction \
      "id:1100,\
      phase:5,\
      nolog,\
      pass,\
      initcol:ip=%{REMOTE_ADDR},\
      setvar:ip.requests_count=+1,\
      expirevar:ip.requests_count={{ .Values.waf.rateLimitWindow | default 60 }}"

    # Block if too many requests
    SecRule IP:REQUESTS_COUNT "@gt {{ .Values.waf.rateLimitRequests | default 100 }}" \
      "id:1101,\
      phase:1,\
      deny,\
      status:429,\
      msg:'Rate limit exceeded',\
      tag:'DOS_PROTECTION',\
      severity:'WARNING'"

    # ============================================
    # Protocol Violations
    # ============================================
    # Block requests with no Host header
    SecRule &REQUEST_HEADERS:Host "@eq 0" \
      "id:1200,\
      phase:2,\
      block,\
      t:none,\
      msg:'Request Missing Host Header',\
      tag:'PROTOCOL_VIOLATION/MISSING_HEADER',\
      severity:'WARNING'"

    # Block requests with multiple Host headers
    SecRule &REQUEST_HEADERS:Host "!@eq 1" \
      "id:1201,\
      phase:2,\
      block,\
      t:none,\
      msg:'Multiple Host Headers',\
      tag:'PROTOCOL_VIOLATION/MISSING_HEADER',\
      severity:'WARNING'"

    # ============================================
    # Scanner Detection
    # ============================================
    SecRule REQUEST_HEADERS:User-Agent "@pmFromFile /etc/nginx/modsecurity/scanners-user-agents.data" \
      "id:1300,\
      phase:2,\
      block,\
      t:none,t:lowercase,\
      msg:'Security Scanner Detected',\
      logdata:'Matched Data: %{MATCHED_VAR}',\
      tag:'AUTOMATION/SECURITY_SCANNER',\
      severity:'CRITICAL'"

    # ============================================
    # File Upload Protection
    # ============================================
    # Block dangerous file extensions
    SecRule FILES "@rx \.(?:php[345]?|phtml|exe|com|bat|cmd|sh|cgi|pl|py|asp|aspx|jsp|jspx|war|jar)$" \
      "id:1400,\
      phase:2,\
      block,\
      t:none,t:lowercase,\
      msg:'Dangerous File Upload Detected',\
      logdata:'Filename: %{MATCHED_VAR}',\
      tag:'OWASP_CRS/WEB_ATTACK/FILE_UPLOAD',\
      severity:'CRITICAL'"

    # ============================================
    # JSON-specific rules
    # ============================================
    # Validate JSON structure
    SecRule REQUEST_HEADERS:Content-Type "@rx ^application/json" \
      "id:1500,\
      phase:2,\
      chain,\
      t:none,t:lowercase,\
      msg:'Invalid JSON Structure',\
      tag:'OWASP_CRS/PROTOCOL_VIOLATION',\
      severity:'WARNING'"
      SecRule REQUEST_BODY "!@validateJsonStructure" \
        "t:none"

    # ============================================
    # TrustLayer API specific rules
    # ============================================
    # Protect admin endpoints
    SecRule REQUEST_URI "@beginsWith /api/admin/" \
      "id:2000,\
      phase:1,\
      chain,\
      t:none,t:lowercase,\
      msg:'Admin endpoint access without proper authentication',\
      tag:'ACCESS_CONTROL',\
      severity:'WARNING'"
      SecRule &REQUEST_HEADERS:Authorization "@eq 0" \
        "deny,\
        status:401"

    # Protect SSO callback endpoints from replay
    SecRule REQUEST_URI "@rx ^/auth/(callback|saml/(acs|callback))" \
      "id:2001,\
      phase:2,\
      pass,\
      nolog,\
      setvar:tx.is_sso_callback=1"

    # Protect Edge Functions
    SecRule REQUEST_URI "@beginsWith /functions/v1/" \
      "id:2002,\
      phase:1,\
      pass,\
      nolog,\
      setvar:tx.is_edge_function=1"

    # Block direct access to sensitive paths
    SecRule REQUEST_URI "@rx \.(?:bak|old|backup|~|swp|git|env|log)$" \
      "id:2003,\
      phase:1,\
      deny,\
      status:404,\
      t:none,t:lowercase,\
      msg:'Attempt to access backup/sensitive file',\
      tag:'INFORMATION_DISCLOSURE',\
      severity:'WARNING'"

{{- if .Values.waf.owaspCRS.enabled }}
  # Include OWASP CRS (Core Rule Set)
  owasp-crs.conf: |
    # OWASP ModSecurity Core Rule Set (CRS) v3.3.x
    # https://github.com/coreruleset/coreruleset

    Include /etc/nginx/modsecurity/owasp-crs/crs-setup.conf
    Include /etc/nginx/modsecurity/owasp-crs/rules/*.conf
{{- end }}

---
# Scanner detection data files
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "trustlayer.fullname" . }}-modsecurity-data
  labels:
    {{- include "trustlayer.labels" . | nindent 4 }}
data:
  scanners-user-agents.data: |
    nikto
    nmap
    sqlmap
    acunetix
    nessus
    masscan
    metasploit
    burpsuite
    w3af
    wpscan
    dirb
    dirbuster
    joomscan
    openvas
    netsparker
    appscan
    webinspect

  lfi-os-files.data: |
    /etc/passwd
    /etc/shadow
    /etc/group
    /etc/hosts
    /etc/motd
    /etc/issue
    c:/windows/win.ini
    c:/winnt/win.ini
    c:/boot.ini
    /proc/self/environ
    /proc/version
    /proc/cmdline
{{- end }}
